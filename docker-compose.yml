services:
  # Основной сервис n8n (всегда запускается)
  n8n:
    build: .
    container_name: n8n
    restart: unless-stopped
    expose:
      - "5678"
    volumes:
      - config-data:/home/node/.n8n
    environment:
      NODE_ENV: production
      N8N_BASIC_AUTH_ACTIVE: ${N8N_BASIC_AUTH_ACTIVE}
      N8N_BASIC_AUTH_USER: ${N8N_BASIC_AUTH_USER}
      N8N_BASIC_AUTH_PASSWORD: ${N8N_BASIC_AUTH_PASSWORD}
      N8N_HOST: ${N8N_HOST}
      N8N_PORT: ${N8N_PORT}
      N8N_PROTOCOL: https
      N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS: true
      N8N_RUNNERS_ENABLED: true
      N8N_SECURE_COOKIE: true
      WEBHOOK_URL: https://${N8N_HOST}
    networks:
      - n8n-network
    profiles:
      - full  # Запускается только в profile "full"

  # Основной nginx с HTTPS (запускается в profile "full")
  nginx:
    image: nginx:alpine
    container_name: n8n-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/templates:/etc/nginx/templates:ro
      - ./certbot/www:/var/www/certbot:ro
      - ./certbot/conf:/etc/letsencrypt:ro
    environment:
      - NGINX_ENVSUBST_TEMPLATE_DIR=/etc/nginx/templates
      - N8N_HOST=${N8N_HOST}
    networks:
      - n8n-network
    depends_on:
      n8n:
        condition: service_started
    profiles:
      - full  # Запускается только в profile "full"

  # Certbot для обновления сертификатов (запускается в profile "full")
  certbot:
    image: certbot/certbot
    container_name: n8n-certbot
    restart: unless-stopped
    volumes:
      - ./certbot/www:/var/www/certbot
      - ./certbot/conf:/etc/letsencrypt
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    networks:
      - n8n-network
    depends_on:
      - nginx
    profiles:
      - full  # Запускается только в profile "full"

  # Временный nginx для первого запуска (только HTTP)
  nginx-first-run:
    image: nginx:alpine
    container_name: n8n-nginx-first-run
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./nginx/templates/first-run:/etc/nginx/templates:ro
      - ./certbot/www:/var/www/certbot:ro
    environment:
      - NGINX_ENVSUBST_TEMPLATE_DIR=/etc/nginx/templates
      - N8N_HOST=${N8N_HOST}
    networks:
      - n8n-network
    profiles:
      - first-run  # Запускается только при FIRST_RUN=true

networks:
  n8n-network:
    driver: bridge

volumes:
  config-data: