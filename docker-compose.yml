services:
  n8n:
    build: .
    container_name: n8n
    restart: unless-stopped
    expose:
      - "5678" 
    volumes:
      - config-data:/home/node/.n8n
    environment:
      NODE_ENV: production
      N8N_BASIC_AUTH_ACTIVE: ${N8N_BASIC_AUTH_ACTIVE}
      N8N_BASIC_AUTH_USER: ${N8N_BASIC_AUTH_USER}
      N8N_BASIC_AUTH_PASSWORD: ${N8N_BASIC_AUTH_PASSWORD}
      N8N_HOST: ${N8N_HOST}
      N8N_PORT: ${N8N_PORT}
      N8N_PROTOCOL: https
      N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS: true
      N8N_RUNNERS_ENABLED: true
      N8N_SECURE_COOKIE: true
      WEBHOOK_URL: https://${N8N_HOST}
    networks:
      - n8n-network


nginx:
  image: nginx:alpine
  container_name: n8n-nginx
  restart: unless-stopped
  ports:
    - "80:80"
    - "443:443"
  volumes:
    - ./nginx/nginx.conf.template:/etc/nginx/templates/nginx.conf.template:ro
    - ./certbot/www:/var/www/certbot:ro
    - ./certbot/conf:/etc/letsencrypt:ro
  environment:
    - N8N_HOST=${N8N_HOST}  # Передаем переменную
  networks:
    - n8n-network
  depends_on:
    - n8n
    
  certbot:
    image: certbot/certbot
    container_name: n8n-certbot
    restart: unless-stopped
    volumes:
      - ./certbot/www:/var/www/certbot
      - ./certbot/conf:/etc/letsencrypt
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    networks:
      - n8n-network
    depends_on:
      - nginx

networks:
  n8n-network:
    driver: bridge

volumes:
  config-data: